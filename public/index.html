<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>悦购积分商城</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
*{margin:0;padding:0;box-sizing:border-box;}
:root{
  --primary:#6c5ce7;
  --primary-dark:#5a4fcf;
  --secondary:#00cec9;
  --accent:#fd79a8;
  --success:#00b894;
  --warning:#fdcb6e;
  --dark:#2d3436;
  --light:#f8f9fa;
  --gray:#636e72;
  --light-gray:#dfe6e9;
  --card-shadow:0 4px 20px rgba(0,0,0,0.08);
  --hover-shadow:0 6px 25px rgba(0,0,0,0.12);
}
body{font-family:'Segoe UI','PingFang SC','Microsoft YaHei',sans-serif; background:linear-gradient(135deg,#f8f9fa 0%,#e8edf3 100%); color:var(--dark); min-height:100vh; padding-bottom:40px;}
.notification{position:fixed;top:20px;right:20px;padding:16px 24px;border-radius:12px;color:white;font-weight:600;box-shadow:0 4px 12px rgba(0,0,0,0.2);z-index:10000;transform:translateX(120%);transition:transform 0.3s ease,opacity 0.3s ease;max-width:320px;}
.notification.show{transform:translateX(0);}
.notification.success{background:var(--success);}
.notification.warning{background:var(--warning);color:var(--dark);}
.notification.error{background:#ff7675;}
.modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);display:flex;justify-content:center;align-items:center;z-index:1000;opacity:0;visibility:hidden;transition:all 0.3s ease;}
.modal.active{opacity:1;visibility:visible;}
.modal-content{background:white;padding:40px;border-radius:20px;width:90%;max-width:450px;box-shadow:var(--hover-shadow);transform:translateY(20px);transition:transform 0.3s ease;}
.modal.active .modal-content{transform:translateY(0);}
.modal h2{text-align:center;margin-bottom:24px;color:var(--primary);font-size:28px;font-weight:700;}
.tabs{display:flex;margin-bottom:24px;border-bottom:2px solid var(--light-gray);}
.tab{padding:12px 24px;cursor:pointer;font-weight:600;color:var(--gray);border-bottom:2px solid transparent;}
.tab.active{color:var(--primary);border-bottom-color:var(--primary);}
.form-group{margin-bottom:20px;}
.form-group label{display:block;margin-bottom:8px;font-weight:600;color:var(--dark);}
.form-group input, .form-group textarea{width:100%;padding:14px;border:2px solid var(--light-gray);border-radius:12px;font-size:16px;transition:border-color 0.3s ease;}
.form-group input:focus, .form-group textarea:focus{outline:none;border-color:var(--primary);}
.submit-btn{width:100%;padding:14px;background:var(--primary);color:white;border:none;border-radius:12px;font-size:16px;font-weight:600;cursor:pointer;transition:background 0.3s ease, transform 0.2s ease;}
.submit-btn:hover{background:var(--primary-dark);transform:translateY(-2px);}
.switch-form{text-align:center;margin-top:16px;color:var(--gray);}
.switch-form a{color:var(--primary);text-decoration:none;font-weight:600;cursor:pointer;}
.navbar{background:white;padding:20px 40px;display:flex;justify-content:space-between;align-items:center;box-shadow:0 2px 15px rgba(0,0,0,0.08);position:sticky;top:0;z-index:100;}
.navbar h1{font-size:28px;font-weight:800;background:linear-gradient(45deg,var(--primary),var(--secondary));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
.auth-btn{background:var(--primary);color:white;border:none;padding:10px 24px;border-radius:12px;font-size:16px;font-weight:600;cursor:pointer;transition:background 0.3s ease;display:flex;align-items:center;gap:8px;}
.auth-btn:hover{background:var(--primary-dark);}
.navbar .user-info{display:flex;align-items:center;gap:20px;}
.user-avatar{width:40px;height:40px;border-radius:50%;background:linear-gradient(45deg,var(--primary),var(--secondary));display:flex;align-items:center;justify-content:center;color:white;font-weight:bold;font-size:16px;}
.logout-btn{background:var(--light-gray);color:var(--gray);border:none;padding:8px 16px;border-radius:8px;cursor:pointer;font-weight:600;transition:all 0.2s ease;}
.logout-btn:hover{background:#c8d6e5;color:var(--dark);}
.user-panel{max-width:1200px;margin:30px auto 0;padding:0 20px;}
.user-card{background:white;border-radius:20px;padding:30px;box-shadow:var(--card-shadow);margin-bottom:30px;}
.user-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;flex-wrap:wrap;gap:20px;}
.user-details h2{font-size:24px;color:var(--dark);margin-bottom:8px;}
.user-details p{color:var(--gray);font-size:16px;}
.points-badge{background:linear-gradient(45deg,var(--primary),var(--secondary));color:white;padding:8px 20px;border-radius:20px;font-weight:700;font-size:18px;display:inline-block;}
.section-title{font-size:24px;font-weight:700;margin-bottom:24px;color:var(--dark);display:flex;align-items:center;gap:12px;}
.section-title i{color:var(--primary);}
.products-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:28px;margin-bottom:40px;}
.product-card{background:white;border-radius:16px;overflow:hidden;box-shadow:var(--card-shadow);transition:all 0.3s ease;height:100%;display:flex;flex-direction:column;}
.product-card:hover{transform:translateY(-8px);box-shadow:var(--hover-shadow);}
.product-image{height:180px;overflow:hidden;}
.product-image img{width:100%;height:100%;object-fit:cover;transition:transform 0.3s ease;}
.product-card:hover .product-image img{transform:scale(1.05);}
.product-info{padding:20px;flex:1;display:flex;flex-direction:column;}
.product-name{font-size:18px;font-weight:700;margin-bottom:10px;color:var(--dark);line-height:1.3;}
.product-desc{color:var(--gray);font-size:14px;margin-bottom:12px;line-height:1.5;flex:1;}
.product-seller{color:var(--secondary);font-size:12px;margin-bottom:12px;}
.product-price{font-size:20px;font-weight:800;color:var(--primary);margin-top:auto;}
.no-products{text-align:center;color:var(--gray);font-size:16px;padding:40px;grid-column:1 / -1;background:var(--light);border-radius:16px;}
.upload-form{background:white;border-radius:20px;padding:30px;box-shadow:var(--card-shadow);margin-bottom:40px;}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px;}
@media (max-width:768px){.form-row{grid-template-columns:1fr;}.navbar{padding:16px 20px;}.navbar h1{font-size:24px;}.user-panel{padding:0 15px;}.user-card,.upload-form{padding:20px;}.products-grid{grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:20px;}.auth-btn{padding:8px 16px;font-size:14px;}}
.action-btn{background:var(--primary);color:white;border:none;padding:12px 24px;border-radius:12px;font-size:16px;font-weight:600;cursor:pointer;transition:all 0.3s ease;display:inline-flex;align-items:center;gap:8px;}
.action-btn:hover{background:var(--primary-dark);transform:translateY(-2px);}
.apply-btn{background:var(--secondary);}
.apply-btn:hover{background:#00b8a9;}
.file-input{position:relative;display:inline-block;width:100%;margin-top:8px;}
.file-input input[type="file"]{position:absolute;left:0;top:0;opacity:0;width:100%;height:100%;cursor:pointer;}
.file-label{display:block;width:100%;padding:14px;border:2px dashed var(--light-gray);border-radius:12px;text-align:center;color:var(--gray);cursor:pointer;transition:all 0.3s ease;}
.file-input input[type="file"]:hover+.file-label{border-color:var(--primary);color:var(--primary);}
.hidden{display:none !important;}
.buy-btn{background:var(--accent);color:white;border:none;padding:10px 20px;border-radius:8px;font-weight:600;cursor:pointer;transition:all 0.2s ease;margin-top:12px;width:100%;}
.buy-btn:hover{background:#ff6b9a;transform:translateY(-1px);}
.buy-btn:disabled{background:var(--light-gray);cursor:not-allowed;transform:none;}
</style>
</head>
<body>
<!-- 通知 -->
<div class="notification" id="notification"></div>

<!-- 登录注册模态框 -->
<div class="modal" id="authModal">
  <div class="modal-content">
    <h2><i class="fas fa-shopping-cart"></i> 悦购积分商城</h2>
    <div class="tabs">
      <div class="tab active" data-tab="login">登录</div>
      <div class="tab" data-tab="register">注册</div>
    </div>
    <form id="loginForm" class="auth-form">
      <div class="form-group"><label>邮箱</label><input type="email" id="loginEmail" placeholder="请输入邮箱" required></div>
      <div class="form-group"><label>密码</label><input type="password" id="loginPassword" placeholder="请输入密码" required></div>
      <button type="submit" class="submit-btn">登录</button>
      <div class="switch-form">还没有账户？<a id="switchToRegister">立即注册</a></div>
    </form>
    <form id="registerForm" class="auth-form hidden">
      <div class="form-group"><label>邮箱</label><input type="email" id="registerEmail" placeholder="请输入邮箱" required></div>
      <div class="form-group"><label>密码</label><input type="password" id="registerPassword" placeholder="请输入密码" required minlength="6"></div>
      <div class="form-group"><label>用户名</label><input type="text" id="registerName" placeholder="请输入用户名" required></div>
      <button type="submit" class="submit-btn">注册</button>
      <div class="switch-form">已有账户？<a id="switchToLogin">立即登录</a></div>
    </form>
  </div>
</div>

<!-- 主内容 -->
<div id="mainContent">
  <nav class="navbar">
    <h1>悦购商城</h1>
    <div id="authButtons"><button class="auth-btn" id="loginBtn"><i class="fas fa-sign-in-alt"></i> 登录/注册</button></div>
    <div class="user-info hidden" id="userInfoNav"><div class="user-avatar" id="userAvatar">U</div><button class="logout-btn" id="logoutBtn">退出登录</button></div>
  </nav>

  <div class="user-panel" id="userPanelSection" style="display:none;">
    <div class="user-card">
      <div class="user-header">
        <div class="user-details">
          <h2 id="userName">用户名</h2>
          <p>角色：<span id="userRole">普通用户</span></p>
        </div>
        <div class="points-badge"><i class="fas fa-coins"></i> <span id="userPoints">0</span> 积分</div>
      </div>
      <button class="action-btn apply-btn" id="applySellerBtn"><i class="fas fa-store"></i> 申请成为商户</button>
    </div>

    <div class="upload-form hidden" id="sellerFormSection">
      <h3 class="section-title"><i class="fas fa-plus-circle"></i> 上架商品</h3>
      <div class="form-row">
        <div class="form-group"><label>商品名称 *</label><input type="text" id="productName" placeholder="请输入商品名称" required></div>
        <div class="form-group"><label>价格（积分） *</label><input type="number" id="productPrice" placeholder="所需积分" min="1" required></div>
      </div>
      <div class="form-group"><label>商品简介 *</label><textarea id="productDesc" placeholder="请输入商品简介" rows="3" required></textarea></div>
      <div class="form-group"><label>商品图片（选填）</label>
        <div class="file-input">
          <input type="file" id="productImage" accept="image/*">
          <div class="file-label">点击选择图片文件（可选）</div>
        </div>
      </div>
      <button class="action-btn" id="submitProductBtn"><i class="fas fa-upload"></i> 上架商品</button>
    </div>
  </div>

  <div class="user-panel">
    <h3 class="section-title"><i class="fas fa-box-open"></i> 精选商品</h3>
    <div class="products-grid" id="productsGrid"></div>
  </div>
</div>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyAzIUyu2Oj0nGgkc6h3qnS6DQkkxsBxzu8",
  authDomain: "guairenxiehui-e3d59.firebaseapp.com",
  databaseURL: "https://guairenxiehui-e3d59-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "guairenxiehui-e3d59",
  storageBucket: "guairenxiehui-e3d59.firebasestorage.app",
  messagingSenderId: "570598758945",
  appId: "1:570598758945:web:5321c2f2d7dd4a7d9fa160",
  measurementId: "G-9VNTHKZBP0"
};

// 初始化 Firebase
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();
const storage = firebase.storage();

// 全局通知函数
function showNotification(message, type='success', duration=3000){
  const notification = document.getElementById('notification');
  notification.textContent = message;
  notification.className = `notification ${type} show`;
  setTimeout(()=>{notification.className='notification';}, duration);
}

// 登录/注册模态逻辑
const authModal = document.getElementById('authModal');
const loginForm = document.getElementById('loginForm');
const registerForm = document.getElementById('registerForm');
const switchToRegister = document.getElementById('switchToRegister');
const switchToLogin = document.getElementById('switchToLogin');
const loginBtn = document.getElementById('loginBtn');

loginBtn.addEventListener('click',()=>authModal.classList.add('active'));
switchToRegister.addEventListener('click',()=>{
  loginForm.classList.add('hidden');
  registerForm.classList.remove('hidden');
});
switchToLogin.addEventListener('click',()=>{
  registerForm.classList.add('hidden');
  loginForm.classList.remove('hidden');
});
authModal.addEventListener('click', e=>{if(e.target===authModal) authModal.classList.remove('active');});

// 登录提交
loginForm.addEventListener('submit', e=>{
  e.preventDefault();
  const email = document.getElementById('loginEmail').value;
  const password = document.getElementById('loginPassword').value;
  auth.signInWithEmailAndPassword(email,password)
    .then(()=>{authModal.classList.remove('active'); showNotification('登录成功');})
    .catch(err=>showNotification(err.message,'error'));
});

// 注册提交
registerForm.addEventListener('submit', e=>{
  e.preventDefault();
  const email = document.getElementById('registerEmail').value;
  const password = document.getElementById('registerPassword').value;
  const name = document.getElementById('registerName').value;
  auth.createUserWithEmailAndPassword(email,password)
    .then(cred=>{
      // 默认积分0，角色为普通用户
      return db.ref('users/'+cred.user.uid).set({name,role:'user',points:0});
    })
    .then(()=>{authModal.classList.remove('active'); showNotification('注册成功');})
    .catch(err=>showNotification(err.message,'error'));
});

// 监听登录状态
auth.onAuthStateChanged(user=>{
  const authButtons = document.getElementById('authButtons');
  const userInfoNav = document.getElementById('userInfoNav');
  const userPanelSection = document.getElementById('userPanelSection');
  if(user){
    authButtons.classList.add('hidden');
    userInfoNav.classList.remove('hidden');
    userPanelSection.style.display='block';
    db.ref('users/'+user.uid).once('value').then(snapshot=>{
      const data = snapshot.val();
      document.getElementById('userName').textContent = data.name || '用户名';
      document.getElementById('userRole').textContent = data.role || '普通用户';
      document.getElementById('userPoints').textContent = data.points || 0;
      document.getElementById('userAvatar').textContent = (data.name||'U').charAt(0).toUpperCase();
      if(data.role==='seller') document.getElementById('sellerFormSection').classList.remove('hidden');
    });
  } else {
    authButtons.classList.remove('hidden');
    userInfoNav.classList.add('hidden');
    userPanelSection.style.display='none';
  }
});

// 登出按钮
document.getElementById('logoutBtn').addEventListener('click', ()=>{
  auth.signOut().then(()=>showNotification('已退出登录'));
});
</script>
<script>
// DOM 元素
const submitProductBtn = document.getElementById('submitProductBtn');
const sellerFormSection = document.getElementById('sellerFormSection');
const productsGrid = document.getElementById('productsGrid');
const applySellerBtn = document.getElementById('applySellerBtn');

// 工具函数：获取名字首字母
function getInitials(name){
  return name? name.charAt(0).toUpperCase():'U';
}

// 渲染商品列表
function renderProducts(){
  productsGrid.innerHTML='';
  db.ref('products').orderByChild('createdAt').once('value')
    .then(snapshot=>{
      const products = [];
      snapshot.forEach(child=>products.push({id:child.key,...child.val()}));
      products.reverse(); // 最新在前
      if(products.length===0){
        productsGrid.innerHTML='<div class="no-products">这里还什么都没有哦</div>';
        return;
      }
      products.forEach(product=>{
        const card = document.createElement('div');
        card.className='product-card';
        const isUserLoggedIn = auth.currentUser;
        const buyBtnHtml = isUserLoggedIn?
          `<button class="buy-btn" onclick="redeemProduct('${product.id}',${product.price})">兑换商品</button>`:
          `<button class="buy-btn" disabled>请先登录</button>`;
        card.innerHTML=`
          <div class="product-image">
            <img src="${product.imageUrl||'https://placehold.co/260x180/6c5ce7/white?text=商品图片'}" alt="${product.name}">
          </div>
          <div class="product-info">
            <div class="product-name">${product.name}</div>
            <div class="product-desc">${product.description}</div>
            <div class="product-seller">商家：${product.sellerName||'未知商家'}</div>
            <div class="product-price"><i class="fas fa-coins"></i> ${product.price}</div>
            ${buyBtnHtml}
          </div>
        `;
        productsGrid.appendChild(card);
      });
    })
    .catch(err=>{console.error(err); productsGrid.innerHTML='<div class="no-products">加载失败</div>';});
}

// 兑换商品
window.redeemProduct = function(productId, price){
  const user = auth.currentUser;
  if(!user){showNotification('请先登录','warning'); return;}
  const userRef = db.ref('users/'+user.uid);
  userRef.once('value').then(snapshot=>{
    const data = snapshot.val();
    if(!data){showNotification('用户信息不存在','error'); return;}
    if((data.points||0)<price){showNotification('积分不足','warning'); return;}
    // 扣积分
    userRef.update({points:(data.points||0)-price});
    // 记录兑换
    db.ref('redemptions').push({
      userId:user.uid,
      productId,
      pointsSpent:price,
      timestamp:Date.now()
    });
    showNotification('兑换成功！');
    document.getElementById('userPoints').textContent=(data.points||0)-price;
  });
};

// 商户申请
function applyAsSeller(){
  const user = auth.currentUser;
  if(!user){showNotification('请先登录','warning'); return;}
  db.ref('users/'+user.uid).once('value').then(snapshot=>{
    const data = snapshot.val();
    if(data.role==='seller'){showNotification('您已是商户','warning'); return;}
    db.ref('sellerApplications').push({
      userId:user.uid,
      userName:data.name||'未知',
      status:'pending',
      appliedAt:Date.now()
    });
    showNotification('商户申请已提交');
  });
}

// 商品上架
function uploadProduct(){
  const user = auth.currentUser;
  if(!user){showNotification('请先登录','warning'); return;}
  const name = document.getElementById('productName').value.trim();
  const desc = document.getElementById('productDesc').value.trim();
  const price = parseInt(document.getElementById('productPrice').value);
  const file = document.getElementById('productImage').files[0];
  if(!name||!desc||!price||price<=0){showNotification('请填写完整商品信息','warning'); return;}
  showNotification('正在上架商品...');
  let uploadPromise = Promise.resolve('');
  if(file){
    const storageRef = storage.ref('products/'+user.uid+'/'+Date.now()+'_'+file.name);
    uploadPromise = storageRef.put(file).then(snapshot=>snapshot.ref.getDownloadURL());
  }
  uploadPromise.then(url=>{
    db.ref('products').push({
      name,
      description:desc,
      price,
      sellerId:user.uid,
      sellerName:user.displayName||name,
      imageUrl:url||'',
      createdAt:Date.now()
    });
    // 清空表单
    document.getElementById('productName').value='';
    document.getElementById('productDesc').value='';
    document.getElementById('productPrice').value='';
    document.getElementById('productImage').value='';
    showNotification('商品上架成功！');
    renderProducts();
  }).catch(err=>showNotification(err.message||'上架失败','error'));
}

// 挂载按钮事件
applySellerBtn.addEventListener('click',applyAsSeller);
submitProductBtn.addEventListener('click',uploadProduct);

// 初始化渲染商品
renderProducts();
</script>
