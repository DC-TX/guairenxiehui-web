<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>æ€ªäººåä¼šå•†åŸ</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    :root {
      --primary: #6c5ce7;
      --primary-dark: #5a4fcf;
      --secondary: #00cec9;
      --accent: #fd79a8;
      --success: #00b894;
      --warning: #fdcb6e;
      --dark: #2d3436;
      --light: #f8f9fa;
      --gray: #636e72;
      --light-gray: #dfe6e9;
      --card-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      --hover-shadow: 0 6px 25px rgba(0, 0, 0, 0.12);
    }
    body {
      font-family: 'Segoe UI', 'PingFang SC', 'Microsoft YaHei', sans-serif;
      background: linear-gradient(135deg, #f8f9fa 0%, #e8edf3 100%);
      color: var(--dark);
      min-height: 100vh;
      padding-bottom: 40px;
    }
    /* é€šçŸ¥æ°”æ³¡ */
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 16px 24px;
      border-radius: 12px;
      color: white;
      font-weight: 600;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      z-index: 10000;
      transform: translateX(120%);
      transition: transform 0.3s ease, opacity 0.3s ease;
      max-width: 320px;
    }
    .notification.show {
      transform: translateX(0);
    }
    .notification.success {
      background: var(--success);
    }
    .notification.warning {
      background: var(--warning);
      color: var(--dark);
    }
    .notification.error {
      background: #ff7675;
    }
    /* ç™»å½•/æ³¨å†Œæ¨¡æ€æ¡† */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }
    .modal.active {
      opacity: 1;
      visibility: visible;
    }
    .modal-content {
      background: white;
      padding: 40px;
      border-radius: 20px;
      width: 90%;
      max-width: 450px;
      box-shadow: var(--hover-shadow);
      transform: translateY(20px);
      transition: transform 0.3s ease;
    }
    .modal.active .modal-content {
      transform: translateY(0);
    }
    .modal h2 {
      text-align: center;
      margin-bottom: 24px;
      color: var(--primary);
      font-size: 28px;
      font-weight: 700;
    }
    .tabs {
      display: flex;
      margin-bottom: 24px;
      border-bottom: 2px solid var(--light-gray);
    }
    .tab {
      padding: 12px 24px;
      cursor: pointer;
      font-weight: 600;
      color: var(--gray);
      border-bottom: 2px solid transparent;
    }
    .tab.active {
      color: var(--primary);
      border-bottom-color: var(--primary);
    }
    .form-group {
      margin-bottom: 20px;
    }
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--dark);
    }
    .form-group input {
      width: 100%;
      padding: 14px;
      border: 2px solid var(--light-gray);
      border-radius: 12px;
      font-size: 16px;
      transition: border-color 0.3s ease;
    }
    .form-group input:focus {
      outline: none;
      border-color: var(--primary);
    }
    .submit-btn {
      width: 100%;
      padding: 14px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.3s ease, transform 0.2s ease;
    }
    .submit-btn:hover {
      background: var(--primary-dark);
      transform: translateY(-2px);
    }
    .switch-form {
      text-align: center;
      margin-top: 16px;
      color: var(--gray);
    }
    .switch-form a {
      color: var(--primary);
      text-decoration: none;
      font-weight: 600;
      cursor: pointer;
    }
    /* é¡¶éƒ¨å¯¼èˆªæ  */
    .navbar {
      background: white;
      padding: 20px 40px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 15px rgba(0, 0, 0, 0.08);
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .navbar h1 {
      font-size: 28px;
      font-weight: 800;
      background: linear-gradient(45deg, var(--primary), var(--secondary));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .auth-btn {
      background: var(--primary);
      color: white;
      border: none;
      padding: 10px 24px;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .auth-btn:hover {
      background: var(--primary-dark);
    }
    .navbar .user-info {
      display: flex;
      align-items: center;
      gap: 20px;
    }
    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(45deg, var(--primary), var(--secondary));
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      font-size: 16px;
    }
    .logout-btn {
      background: var(--light-gray);
      color: var(--gray);
      border: none;
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s ease;
    }
    .logout-btn:hover {
      background: #c8d6e5;
      color: var(--dark);
    }
    /* ç®¡ç†å‘˜æŒ‰é’® */
    .admin-btn {
      background: var(--secondary);
      color: white;
    }
    .admin-btn:hover {
      background: #00b8a9;
    }
    /* å•†å®¶æŒ‰é’® */
    .seller-orders-btn {
      background: #74b9ff;
      color: white;
    }
    .seller-orders-btn:hover {
      background: #0984e3;
    }
    /* ç”¨æˆ·é¢æ¿ */
    .user-panel {
      max-width: 1200px;
      margin: 30px auto 0;
      padding: 0 20px;
    }
    .user-card {
      background: white;
      border-radius: 20px;
      padding: 30px;
      box-shadow: var(--card-shadow);
      margin-bottom: 30px;
    }
    .user-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 20px;
    }
    .user-details h2 {
      font-size: 24px;
      color: var(--dark);
      margin-bottom: 8px;
    }
    .user-details p {
      color: var(--gray);
      font-size: 16px;
    }
    .points-badge {
      background: linear-gradient(45deg, var(--primary), var(--secondary));
      color: white;
      padding: 8px 20px;
      border-radius: 20px;
      font-weight: 700;
      font-size: 18px;
      display: inline-block;
    }
    /* å•†å“åŒº */
    .section-title {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 24px;
      color: var(--dark);
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .section-title i {
      color: var(--primary);
    }
    .products-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
      gap: 28px;
      margin-bottom: 40px;
    }
    .product-card {
      background: white;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: var(--card-shadow);
      transition: all 0.3s ease;
      height: 100%;
      display: flex;
      flex-direction: column;
    }
    .product-card:hover {
      transform: translateY(-8px);
      box-shadow: var(--hover-shadow);
    }
    .product-image {
      height: 180px;
      overflow: hidden;
    }
    .product-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: transform 0.3s ease;
    }
    .product-card:hover .product-image img {
      transform: scale(1.05);
    }
    .product-info {
      padding: 20px;
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    .product-name {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 10px;
      color: var(--dark);
      line-height: 1.3;
    }
    .product-desc {
      color: var(--gray);
      font-size: 14px;
      margin-bottom: 16px;
      line-height: 1.5;
      flex: 1;
    }
    .product-sales {
      font-size: 14px;
      color: var(--gray);
      margin-bottom: 8px;
    }
    .product-price {
      font-size: 20px;
      font-weight: 800;
      color: var(--primary);
      margin-top: auto;
    }
    .no-products {
      text-align: center;
      color: var(--gray);
      font-size: 16px;
      padding: 40px;
      grid-column: 1 / -1;
      background: var(--light);
      border-radius: 16px;
    }
    /* è¡¨å•åŒº */
    .upload-form {
      background: white;
      border-radius: 20px;
      padding: 30px;
      box-shadow: var(--card-shadow);
      margin-bottom: 40px;
    }
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }
    @media (max-width: 768px) {
      .form-row {
        grid-template-columns: 1fr;
      }
    }
    .action-btn {
      background: var(--primary);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    .action-btn:hover {
      background: var(--primary-dark);
      transform: translateY(-2px);
    }
    .apply-btn {
      background: var(--secondary);
      color: white;
    }
    .apply-btn:hover {
      background: #00b8a9;
    }
    .file-input {
      position: relative;
      display: inline-block;
      width: 100%;
      margin-top: 8px;
    }
    .file-input input[type="file"] {
      position: absolute;
      left: 0;
      top: 0;
      opacity: 0;
      width: 100%;
      height: 100%;
      cursor: pointer;
    }
    .file-label {
      display: block;
      width: 100%;
      padding: 14px;
      border: 2px dashed var(--light-gray);
      border-radius: 12px;
      text-align: center;
      color: var(--gray);
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .file-input input[type="file"]:hover + .file-label {
      border-color: var(--primary);
      color: var(--primary);
    }
    .hidden {
      display: none !important;
    }
    /* å“åº”å¼ */
    @media (max-width: 768px) {
      .navbar {
        padding: 16px 20px;
      }
      .navbar h1 {
        font-size: 24px;
      }
      .user-panel {
        padding: 0 15px;
      }
      .user-card, .upload-form {
        padding: 20px;
      }
      .products-grid {
        grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
        gap: 20px;
      }
      .auth-btn {
        padding: 8px 16px;
        font-size: 14px;
      }
    }
    /* è´­ä¹°æŒ‰é’® */
    .buy-btn {
      background: var(--accent);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      margin-top: 12px;
      width: 100%;
    }
    .buy-btn:hover {
      background: #ff6b9a;
      transform: translateY(-1px);
    }
    .buy-btn:disabled {
      background: var(--light-gray);
      cursor: not-allowed;
      transform: none;
    }
    /* ç®¡ç†å‘˜ç•Œé¢ */
    .admin-section {
      background: white;
      border-radius: 20px;
      padding: 30px;
      box-shadow: var(--card-shadow);
      margin-bottom: 40px;
    }
    .admin-section h3 {
      margin-bottom: 20px;
      font-size: 18px;
      color: var(--dark);
    }
    .application-item {
      padding: 12px;
      border-bottom: 1px solid var(--light-gray);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .application-item:last-child {
      border-bottom: none;
    }
    .approve-btn, .reject-btn {
      padding: 6px 12px;
      border: none;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      margin-left: 8px;
    }
    .approve-btn {
      background: var(--success);
      color: white;
    }
    .reject-btn {
      background: #ff7675;
      color: white;
    }
    .user-item {
      padding: 12px;
      border-bottom: 1px solid var(--light-gray);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .user-item:last-child {
      border-bottom: none;
    }
    .points-input {
      width: 80px;
      padding: 4px;
      border: 1px solid var(--light-gray);
      border-radius: 4px;
      margin: 0 8px;
    }
    .ban-btn {
      background: #ff4757;
      color: white;
    }
    .unban-btn {
      background: var(--success);
      color: white;
    }
    /* ç®¡ç†å‘˜å¼¹çª— */
    .admin-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }
    .admin-modal.active {
      opacity: 1;
      visibility: visible;
    }
    .admin-modal-content {
      background: white;
      padding: 40px;
      border-radius: 20px;
      width: 90%;
      max-width: 800px;
      box-shadow: var(--hover-shadow);
      transform: translateY(20px);
      transition: transform 0.3s ease;
      max-height: 80vh;
      overflow-y: auto;
    }
    .admin-modal.active .admin-modal-content {
      transform: translateY(0);
    }
    .admin-modal h3 {
      margin-bottom: 20px;
      color: var(--primary);
      font-size: 24px;
      font-weight: 700;
    }
    .admin-tabs {
      display: flex;
      margin-bottom: 24px;
      border-bottom: 2px solid var(--light-gray);
    }
    .admin-tab {
      padding: 12px 24px;
      cursor: pointer;
      font-weight: 600;
      color: var(--gray);
      border-bottom: 2px solid transparent;
    }
    .admin-tab.active {
      color: var(--primary);
      border-bottom-color: var(--primary);
    }
    .admin-pane {
      display: none;
    }
    .admin-pane.active {
      display: block;
    }
    /* å•†å®¶è®¢å•æ¨¡æ€æ¡† */
    .orders-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }
    .orders-modal.active {
      opacity: 1;
      visibility: visible;
    }
    .orders-modal-content {
      background: white;
      padding: 40px;
      border-radius: 20px;
      width: 90%;
      max-width: 800px;
      box-shadow: var(--hover-shadow);
      transform: translateY(20px);
      transition: transform 0.3s ease;
      max-height: 80vh;
      overflow-y: auto;
    }
    .orders-modal.active .orders-modal-content {
      transform: translateY(0);
    }
    .order-item {
      padding: 15px;
      border-bottom: 1px solid var(--light-gray);
    }
    .order-item:last-child {
      border-bottom: none;
    }
    .order-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
    }
    .order-buyer {
      color: var(--secondary);
      font-weight: 500;
    }
    .order-product {
      font-weight: 600;
      color: var(--dark);
    }
    .order-sales {
      font-size: 14px;
      color: var(--gray);
      margin-top: 4px;
    }
    .order-points {
      color: var(--primary);
      font-weight: 700;
    }
    .order-time {
      font-size: 12px;
      color: var(--gray);
      margin-top: 5px;
    }
    .delete-btn {
      position: absolute;
      top: 12px;
      right: 12px;
      width: 32px;
      height: 32px;
      background: rgba(255, 118, 117, 0.9); /* --danger with opacity */
      border: none;
      border-radius: 50%;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
      opacity: 0;
      transition: opacity 0.2s ease;
      z-index: 2;
    }
    .product-card:hover .delete-btn {
      opacity: 1;
    }
    .delete-btn:hover {
      background: #ff4757;
      transform: scale(1.1);
    }
    .product-image {
      position: relative;
    }
    /* å›¾ç‰‡é¢„è§ˆåŒºåŸŸ */
    .image-preview {
      margin-top: 15px;
      text-align: center;
    }

    .image-preview img {
      max-width: 100%;
      max-height: 200px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      display: none; /* åˆå§‹éšè— */
    }

    /* ä¸Šä¼ è¿›åº¦æ¡ */
    .upload-progress {
      margin-top: 15px;
      padding: 10px;
      background: #f8f9fa;
      border-radius: 8px;
      display: none; /* åˆå§‹éšè— */
    }

    .upload-progress .progress-bar {
      width: 100%;
      height: 8px;
      background: #dfe6e9;
      border-radius: 4px;
      overflow: hidden;
      margin: 10px 0;
    }

    .upload-progress .progress-inner {
      height: 100%;
      background: var(--primary);
      width: 0%;
      transition: width 0.3s ease;
    }

    .upload-progress .progress-text {
      font-size: 14px;
      color: var(--dark);
    }
  </style>
</head>
<body>
  <!-- é€šçŸ¥æ°”æ³¡ -->
  <div class="notification" id="notification"></div>
  <!-- ç™»å½•/æ³¨å†Œæ¨¡æ€æ¡† -->
  <div class="modal" id="authModal">
    <div class="modal-content fade-in">
      <h2><i class="fas fa-shopping-cart"></i> æ€ªäººåä¼šå•†åŸ</h2>
      <div class="tabs">
        <div class="tab active" data-tab="login">ç™»å½•</div>
        <div class="tab" data-tab="register">æ³¨å†Œ</div>
      </div>
      <form id="loginForm" class="auth-form">
        <div class="form-group">
          <label for="loginEmail">é‚®ç®±</label>
          <input type="email" id="loginEmail" placeholder="è¯·è¾“å…¥é‚®ç®±" required>
        </div>
        <div class="form-group">
          <label for="loginPassword">å¯†ç </label>
          <input type="password" id="loginPassword" placeholder="è¯·è¾“å…¥å¯†ç " required>
        </div>
        <button type="submit" class="submit-btn">ç™»å½•</button>
        <div class="switch-form">
          è¿˜æ²¡æœ‰è´¦æˆ·ï¼Ÿ<a id="switchToRegister">ç«‹å³æ³¨å†Œ</a>
        </div>
      </form>
      <form id="registerForm" class="auth-form hidden">
        <div class="form-group">
          <label for="registerEmail">é‚®ç®±</label>
          <input type="email" id="registerEmail" placeholder="è¯·è¾“å…¥é‚®ç®±" required>
        </div>
        <div class="form-group">
          <label for="registerPassword">å¯†ç </label>
          <input type="password" id="registerPassword" placeholder="è¯·è¾“å…¥å¯†ç ï¼ˆè‡³å°‘6ä½ï¼‰" required minlength="6">
        </div>
        <div class="form-group">
          <label for="registerName">ç”¨æˆ·å</label>
          <input type="text" id="registerName" placeholder="è¯·è¾“å…¥ç”¨æˆ·å" required>
        </div>
        <button type="submit" class="submit-btn">æ³¨å†Œ</button>
        <div class="switch-form">
          å·²æœ‰è´¦æˆ·ï¼Ÿ<a id="switchToLogin">ç«‹å³ç™»å½•</a>
        </div>
      </form>
    </div>
  </div>
  <!-- ç®¡ç†å‘˜ç®¡ç†å¼¹çª— -->
  <div class="admin-modal" id="adminModal">
    <div class="admin-modal-content">
      <h3><i class="fas fa-shield-alt"></i> ç®¡ç†å‘˜æ§åˆ¶å°</h3>
      <div class="admin-tabs">
        <div class="admin-tab active" data-tab="applications">å•†æˆ·ç”³è¯·å®¡æ ¸</div>
        <div class="admin-tab" data-tab="users">ç”¨æˆ·ç®¡ç†</div>
      </div>
      <div class="admin-pane active" id="applicationsPane">
        <div id="applicationsList">
          <div class="gray">åŠ è½½ä¸­...</div>
        </div>
      </div>
      <div class="admin-pane" id="usersPane">
        <div id="usersList">
          <div class="gray">åŠ è½½ä¸­...</div>
        </div>
      </div>
      <button style="width:100%;margin-top:20px;" onclick="adminModal.classList.remove('active')">å…³é—­</button>
    </div>
  </div>
  <!-- å•†å®¶è®¢å•ç®¡ç†å¼¹çª— -->
  <div class="orders-modal" id="sellerOrdersModal">
    <div class="orders-modal-content">
      <h3><i class="fas fa-shopping-bag"></i> æˆ‘çš„è®¢å•</h3>
      <div id="sellerOrdersList">
        <div class="gray">åŠ è½½ä¸­...</div>
      </div>
      <button style="width:100%;margin-top:20px;" onclick="sellerOrdersModal.classList.remove('active')">å…³é—­</button>
    </div>
  </div>
  <!-- ä¸»é¡µé¢å†…å®¹ -->
  <div id="mainContent">
    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <nav class="navbar">
      <h1>æ€ªäººåä¼šå•†åŸ</h1>
      <div id="authButtons">
        <button class="auth-btn" id="loginBtn">
          <i class="fas fa-sign-in-alt"></i> ç™»å½•/æ³¨å†Œ
        </button>
      </div>
      <div class="user-info hidden" id="userInfoNav">
        <div class="user-avatar" id="userAvatar">U</div>
        <button class="logout-btn" id="logoutBtn">é€€å‡ºç™»å½•</button>
        <button class="seller-orders-btn hidden" id="sellerOrdersBtn">æˆ‘çš„è®¢å•</button>
        <button class="admin-btn hidden" id="adminBtn">ç®¡ç†ä¸“ç”¨</button>
      </div>
    </nav>
    <!-- ç”¨æˆ·ä¿¡æ¯é¢æ¿ï¼ˆä»…ç™»å½•ç”¨æˆ·æ˜¾ç¤ºï¼‰ -->
    <div class="user-panel" id="userPanelSection" style="display: none;">
      <div class="user-card">
        <div class="user-header">
          <div class="user-details">
            <h2 id="userName">ç”¨æˆ·å</h2>
            <p>è§’è‰²ï¼š<span id="userRole">æ™®é€šç”¨æˆ·</span></p>
          </div>
          <div class="points-badge">
            <i class="fas fa-coins"></i> <span id="userPoints">0</span> åå¸
          </div>
        </div>
        <button class="action-btn apply-btn" id="applySellerBtn">
          <i class="fas fa-store"></i> ç”³è¯·æˆä¸ºå•†æˆ·
        </button>
      </div>
      <!-- å•†æˆ·ä¸Šæ¶è¡¨å•ï¼ˆä»…å•†æˆ·æ˜¾ç¤ºï¼‰ -->
      <div class="upload-form hidden" id="sellerFormSection">
        <h3 class="section-title"><i class="fas fa-plus-circle"></i> ä¸Šæ¶å•†å“</h3>
        <div class="form-row">
          <div class="form-group">
            <label for="productName">å•†å“åç§° *</label>
            <input type="text" id="productName" placeholder="è¯·è¾“å…¥å•†å“åç§°" required>
          </div>
          <div class="form-group">
            <label for="productPrice">ä»·æ ¼ï¼ˆåå¸ï¼‰ *</label>
            <input type="number" id="productPrice" placeholder="æ‰€éœ€åå¸" min="1" required>
          </div>
        </div>
        <div class="form-group">
          <label for="productDesc">å•†å“ç®€ä»‹ *</label>
          <textarea id="productDesc" placeholder="è¯·è¾“å…¥å•†å“ç®€ä»‹" rows="3" required></textarea>
        </div>
        <div class="form-group">
          <label for="productImage">å•†å“å›¾ç‰‡ï¼ˆé€‰å¡«ï¼‰</label>
          <div class="file-input">
            <input type="file" id="productImage" accept="image/*">
            <div class="file-label">ç‚¹å‡»é€‰æ‹©å›¾ç‰‡æ–‡ä»¶ï¼ˆå¯é€‰ï¼‰</div>
          </div>
        </div>
        <button class="action-btn" id="submitProductBtn">
          <i class="fas fa-upload"></i> ä¸Šæ¶å•†å“
        </button>
      </div>
    </div>
    <!-- å•†å“å±•ç¤ºåŒºï¼ˆæ‰€æœ‰ç”¨æˆ·å¯è§ï¼‰ -->
    <div class="user-panel">
      <h3 class="section-title"><i class="fas fa-box-open"></i> ç²¾é€‰å•†å“</h3>
      <div class="products-grid" id="productsGrid">
        <!-- å•†å“å°†é€šè¿‡ JS åŠ¨æ€æ’å…¥ -->
      </div>
    </div>
  </div>
  <!-- Firebase SDKï¼ˆä¿æŒæ‚¨çš„åŸå§‹é…ç½®ï¼Œä½¿ç”¨ compat æ¨¡å¼ï¼‰-->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
  <script>
    // ========== Firebase é…ç½®ï¼ˆå®Œå…¨ä¿ç•™æ‚¨æä¾›çš„é…ç½®ï¼‰==========
    const firebaseConfig = {
      apiKey: "AIzaSyAzIUyu2Oj0nGgkc6h3qnS6DQkkxsBxzu8",
      authDomain: "guairenxiehui-e3d59.firebaseapp.com",
      databaseURL: "https://guairenxiehui-e3d59-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "guairenxiehui-e3d59",
      storageBucket: "guairenxiehui-e3d59.firebasestorage.app",
      messagingSenderId: "570598758945",
      appId: "1:570598758945:web:5321c2f2d7dd4a7d9fa160"
    };
    // åˆå§‹åŒ– Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();
    const storage = firebase.storage();
    // ========== é€šçŸ¥ç³»ç»Ÿ ==========
    function showNotification(message, type = 'success') {
      const notification = document.getElementById('notification');
      notification.textContent = message;
      notification.className = 'notification ' + type + ' show';
      setTimeout(() => {
        notification.classList.remove('show');
      }, 3000);
    }
    // ========== DOM å…ƒç´  ==========
    const authModal = document.getElementById('authModal');
    const loginBtn = document.getElementById('loginBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const userInfoNav = document.getElementById('userInfoNav');
    const authButtons = document.getElementById('authButtons');
    const userPanelSection = document.getElementById('userPanelSection');
    const authForms = document.querySelectorAll('.auth-form');
    const tabs = document.querySelectorAll('.tab');
    const switchToRegister = document.getElementById('switchToRegister');
    const switchToLogin = document.getElementById('switchToLogin');
    const loginForm = document.getElementById('loginForm');
    const registerForm = document.getElementById('registerForm');
    const applySellerBtn = document.getElementById('applySellerBtn');
    const submitProductBtn = document.getElementById('submitProductBtn');
    const sellerFormSection = document.getElementById('sellerFormSection');
    const productsGrid = document.getElementById('productsGrid');
    const userAvatar = document.getElementById('userAvatar');
    const userName = document.getElementById('userName');
    const userRole = document.getElementById('userRole');
    const userPoints = document.getElementById('userPoints');
    const adminBtn = document.getElementById('adminBtn');
    const adminModal = document.getElementById('adminModal');
    const applicationsPane = document.getElementById('applicationsPane');
    const usersPane = document.getElementById('usersPane');
    const applicationsList = document.getElementById('applicationsList');
    const usersList = document.getElementById('usersList');
    // ========== å•†å®¶åŠŸèƒ½ç›¸å…³ ==========
    const sellerOrdersBtn = document.getElementById('sellerOrdersBtn');
    const sellerOrdersModal = document.getElementById('sellerOrdersModal');
    const sellerOrdersList = document.getElementById('sellerOrdersList');
    // ========== å·¥å…·å‡½æ•° ==========
    function getInitials(name) {
      return name ? name.charAt(0).toUpperCase() : 'U';
    }
    // ========== èº«ä»½éªŒè¯åŠŸèƒ½ ==========
    function showLoginModal() {
      authModal.classList.add('active');
    }
    function hideLoginModal() {
      authModal.classList.remove('active');
    }
    function switchTab(tabName) {
      tabs.forEach(tab => {
        tab.classList.toggle('active', tab.dataset.tab === tabName);
      });
      authForms.forEach(form => {
        form.classList.toggle('hidden', !form.id.includes(tabName));
      });
    }
    // ç™»å½•
    function handleLogin(email, password) {
      auth.signInWithEmailAndPassword(email, password)
        .then(() => {
          hideLoginModal();
          showNotification('ç™»å½•æˆåŠŸï¼');
        })
        .catch(error => {
          console.error('Login error:', error);
          let errorMessage = 'ç™»å½•å¤±è´¥ï¼šè¯·æ£€æŸ¥é‚®ç®±å’Œå¯†ç ';
          if (error.code === 'auth/user-not-found') {
            errorMessage = 'ç”¨æˆ·ä¸å­˜åœ¨ï¼Œè¯·æ£€æŸ¥é‚®ç®±';
          } else if (error.code === 'auth/wrong-password') {
            errorMessage = 'å¯†ç é”™è¯¯ï¼Œè¯·é‡è¯•';
          } else if (error.code === 'auth/invalid-email') {
            errorMessage = 'é‚®ç®±æ ¼å¼æ— æ•ˆ';
          } else if (error.code === 'auth/user-disabled') {
            errorMessage = 'è´¦å·å·²è¢«ç¦ç”¨';
          }
          showNotification(errorMessage, 'error');
        });
    }
    // æ³¨å†Œ
    function handleRegister(email, password, name) {
      auth.createUserWithEmailAndPassword(email, password)
        .then(userCredential => {
          const user = userCredential.user;
          // åœ¨ Realtime Database ä¸­åˆ›å»ºç”¨æˆ·æ–‡æ¡£
          db.ref("users/" + user.uid).set({
            email: email,
            name: name,
            role: "user",
            points: 1000,
            banned: false,
            createdAt: firebase.database.ServerValue.TIMESTAMP
          });
          showNotification('æ³¨å†ŒæˆåŠŸï¼è¯·ç™»å½•');
          switchTab('login');
        })
        .catch(error => {
          console.error('Register error:', error);
          let errorMessage = 'æ³¨å†Œå¤±è´¥ï¼šè¯·æ£€æŸ¥ä¿¡æ¯';
          if (error.code === 'auth/email-already-in-use') {
            errorMessage = 'è¯¥é‚®ç®±å·²è¢«æ³¨å†Œï¼è¯·ç›´æ¥ç™»å½•æˆ–ä½¿ç”¨æ‰¾å›å¯†ç åŠŸèƒ½';
          } else if (error.code === 'auth/invalid-email') {
            errorMessage = 'é‚®ç®±æ ¼å¼æ— æ•ˆ';
          } else if (error.code === 'auth/operation-not-allowed') {
            errorMessage = 'æ³¨å†ŒåŠŸèƒ½æœªå¯ç”¨';
          } else if (error.code === 'auth/weak-password') {
            errorMessage = 'å¯†ç è¿‡äºç®€å•ï¼Œè‡³å°‘éœ€è¦6ä½å­—ç¬¦';
          }
          showNotification(errorMessage, 'error');
        });
    }
    // åœ¨ä½ åŸæœ‰ <script> ä¸­ï¼Œæ‰¾åˆ° renderProducts() å‡½æ•°ï¼Œ**æ›¿æ¢æ•´ä¸ªå‡½æ•°ä¸ºä»¥ä¸‹ç‰ˆæœ¬**
    // ï¼ˆä»…å¢åŠ åˆ é™¤æŒ‰é’®é€»è¾‘ï¼Œå…¶ä½™å®Œå…¨ä¸€è‡´ï¼‰
    function renderProducts() {
      productsGrid.innerHTML = '';
      const currentUser = auth.currentUser;
      // å¦‚æœæœªç™»å½•ï¼Œç›´æ¥æ¸²æŸ“å•†å“ï¼ˆä¸æ˜¾ç¤ºåˆ é™¤æŒ‰é’®ï¼‰
      if (!currentUser) {
        // ç›´æ¥åŠ è½½å•†å“åˆ—è¡¨
        loadProducts();
        return;
      }
      // å¦‚æœå·²ç™»å½•ï¼Œå…ˆè·å–ç”¨æˆ·è§’è‰²
      db.ref(`users/${currentUser.uid}`).once('value')
        .then(userSnapshot => {
          if (!userSnapshot.exists()) {
            showNotification('ç”¨æˆ·æ•°æ®å¼‚å¸¸ï¼Œè¯·é‡æ–°ç™»å½•', 'error');
            auth.signOut();
            return;
          }
          const userData = userSnapshot.val();
          const currentUserRole = userData.role || 'user';
          // è·å–è§’è‰²åï¼Œå†åŠ è½½å•†å“
          loadProducts(currentUserRole);
        })
        .catch(error => {
          console.error('è·å–ç”¨æˆ·è§’è‰²å¤±è´¥:', error);
          showNotification('åŠ è½½å•†å“å¤±è´¥ï¼šæ— æ³•è·å–ç”¨æˆ·æƒé™', 'error');
          // å³ä½¿å‡ºé”™ï¼Œä¹Ÿå°è¯•åŠ è½½å•†å“ï¼ˆä»¥æ¸¸å®¢èº«ä»½ï¼‰
          loadProducts();
        });
      // å°è£…å•†å“åŠ è½½é€»è¾‘
      function loadProducts(role = 'guest') {
        db.ref("products").once("value")
          .then(snapshot => {
            if (!snapshot.exists()) {
              productsGrid.innerHTML = '<div class="no-products">è¿™é‡Œè¿˜ä»€ä¹ˆéƒ½æ²¡æœ‰å“¦</div>';
              return;
            }
            const products = [];
            snapshot.forEach(child => {
              products.push({ id: child.key, ...child.val() });
            });
            products.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
            products.forEach(product => {
              const card = document.createElement('div');
              card.className = 'product-card';
              const isUserLoggedIn = auth.currentUser;
              const buyButtonHtml = isUserLoggedIn ? 
                `<button class="buy-btn" onclick="redeemProduct('${product.id}', ${product.price})">å…‘æ¢å•†å“</button>` :
                `<button class="buy-btn" disabled>è¯·å…ˆç™»å½•</button>`;
              const sellerName = product.sellerName || 'æœªçŸ¥å•†å®¶';
              const sales = product.sales || 0;
              // === æ–°å¢ï¼šä»…ç®¡ç†å‘˜æ˜¾ç¤ºåˆ é™¤æŒ‰é’® ===
              let deleteButtonHtml = '';
              if (role === 'admin') { // ğŸ‘ˆ ä½¿ç”¨ä¼ å…¥çš„ role å‚æ•°
                const safeImgUrl = (product.img || '').replace(/'/g, "\\'");
                deleteButtonHtml = `<button class="delete-btn" onclick="deleteProduct('${product.id}', '${safeImgUrl}')">
                  <i class="fas fa-trash" style="font-size:14px;"></i>
                </button>`;
              }
              card.innerHTML = `
                <div class="product-image">
                  <img src="${product.img || 'https://placehold.co/260x180/6c5ce7/white?text=å•†å“å›¾ç‰‡'}" alt="${product.name || 'å•†å“'}" onerror="this.src='https://placehold.co/260x180/6c5ce7/white?text=å›¾ç‰‡åŠ è½½å¤±è´¥'">
                  ${deleteButtonHtml}
                </div>
                <div class="product-info">
                  <div class="product-name">${product.name || 'æœªå‘½åå•†å“'}</div>
                  <div class="product-desc">${product.desc || 'æš‚æ— æè¿°'}</div>
                  <div class="product-sales">é”€é‡: ${sales} ä»¶</div>
                  <div class="product-seller">å•†å®¶ï¼š${sellerName}</div>
                  <div class="product-price"><i class="fas fa-coins"></i> ${product.price || 0} åå¸</div>
                  ${buyButtonHtml}
                </div>
              `;
              productsGrid.appendChild(card);
            });
          })
          .catch(error => {
            console.error('Error rendering products:', error);
            if (error.code !== 'PERMISSION_DENIED') {
              productsGrid.innerHTML = '<div class="no-products">åŠ è½½å•†å“å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•</div>';
            } else {
              productsGrid.innerHTML = '<div class="no-products">æš‚æ— å•†å“</div>';
            }
          });
      }
    }
    // å…‘æ¢å•†å“ - è¶…ç®€åŒ–ç‰ˆï¼ˆ100% å·¥ä½œï¼‰
    window.redeemProduct = function(productId, price) {
      if (!auth.currentUser) {
        showNotification('è¯·å…ˆç™»å½•', 'warning');
        return;
      }
      const user = auth.currentUser;
      const timestamp = Date.now();
      let userData, productData, sellerId;
      // 1. è·å–ç”¨æˆ·æ•°æ®
      db.ref(`users/${user.uid}`).once('value')
        .then(snapshot => {
          if (!snapshot.exists()) throw new Error('ç”¨æˆ·æ•°æ®ä¸å­˜åœ¨');
          userData = snapshot.val();
          if (userData.banned) throw new Error('è´¦å·å·²è¢«å°ç¦');
          const currentPoints = userData.points || 0;
          if (currentPoints < price) throw new Error('åå¸ä¸è¶³');
          // 2. è·å–å•†å“æ•°æ®
          return db.ref(`products/${productId}`).once('value');
        })
        .then(snapshot => {
          if (!snapshot.exists()) throw new Error('å•†å“ä¸å­˜åœ¨');
          productData = snapshot.val();
          sellerId = productData.sellerId;
          if (!sellerId) throw new Error('å–å®¶ä¿¡æ¯ç¼ºå¤±');
          if (productData.price !== price) throw new Error('å•†å“ä»·æ ¼å·²æ›´æ–°');
          // 3. åˆ›å»ºè®¢å•ï¼ˆç®€å• set æ“ä½œï¼‰
          const orderId = Date.now().toString() + '_' + user.uid.substring(0, 8);
          return db.ref(`orders/${orderId}`).set({
            buyerId: user.uid,
            sellerId: sellerId,
            productId: productId,
            productName: productData.name || 'å•†å“',
            buyerName: userData.name || 'ç”¨æˆ·',
            points: price,
            timestamp: timestamp,
            status: 'completed'
          });
        })
        .then(() => {
          // 4. æ‰£å‡ä¹°å®¶åå¸ï¼ˆç®€å• set æ“ä½œï¼‰
          const buyerPoints = (userData.points || 0) - price;
          return db.ref(`users/${user.uid}/points`).set(buyerPoints);
        })
        .then(() => {
          // 5. å¢åŠ å•†å“é”€é‡
          const newSales = (productData.sales || 0) + 1;
          return db.ref(`products/${productId}/sales`).set(newSales);
        })
        .then(() => {
          // 6. è·å–å–å®¶å½“å‰åå¸
          return db.ref(`users/${sellerId}/points`).once('value');
        })
        .then(sellerSnapshot => {
          const sellerPoints = sellerSnapshot.exists() ? (sellerSnapshot.val().points || 0) : 0;
          // 7. å¢åŠ å–å®¶åå¸
          return db.ref(`users/${sellerId}/points`).set(sellerPoints + price);
        })
        .then(() => {
          // 8. é€šçŸ¥å–å®¶
          db.ref(`notifications/${sellerId}`).push({
            message: `æ–°è®¢å•ï¼${userData.name || 'ç”¨æˆ·'}è´­ä¹°äº†"${productData.name || 'å•†å“'}"`,
            type: 'success',
            timestamp: timestamp
          }).catch(e => console.log('é€šçŸ¥å–å®¶å¤±è´¥:', e));
          // 9. é€šçŸ¥ä¹°å®¶
          db.ref(`notifications/${user.uid}`).push({
            message: `å…‘æ¢æˆåŠŸï¼"${productData.name || 'å•†å“'}"èŠ±è´¹${price}åå¸`,
            type: 'success',
            timestamp: timestamp
          }).catch(e => console.log('é€šçŸ¥ä¹°å®¶å¤±è´¥:', e));
          showNotification(`âœ… å…‘æ¢æˆåŠŸï¼${productData.name}å³å°†é€è¾¾`, 'success');
          renderProducts(); // åˆ·æ–°å•†å“åˆ—è¡¨
        })
        .catch(error => {
          console.error('âŒ å…‘æ¢å¤±è´¥:', error);
          let errorMessage = 'å…‘æ¢å¤±è´¥';
          if (error.message.includes('åå¸ä¸è¶³')) {
            errorMessage = 'âŒ åå¸ä¸è¶³ï¼Œæ— æ³•å…‘æ¢';
          } else if (error.message.includes('å°ç¦')) {
            errorMessage = 'âŒ è´¦å·å·²è¢«å°ç¦';
          } else if (error.message.includes('ä»·æ ¼å·²æ›´æ–°')) {
            errorMessage = 'ğŸ”„ å•†å“ä»·æ ¼å·²æ›´æ–°ï¼Œè¯·åˆ·æ–°é¡µé¢';
          } else if (error.message.includes('PERMISSION_DENIED') || 
                    error.message.includes('permission_denied') || 
                    error.message.includes('permission denied')) {
            errorMessage = 'ğŸ”§ æƒé™é”™è¯¯ï¼šè¯·åˆ·æ–°é¡µé¢æˆ–è”ç³»ç®¡ç†å‘˜';
            // è¯¦ç»†è¯Šæ–­
            console.error('ğŸ”§ è¯¦ç»†é”™è¯¯ä¿¡æ¯:', {
              code: error.code,
              message: error.message,
              stack: error.stack ? error.stack.substring(0, 200) : 'æ— å †æ ˆ'
            });
          } else {
            errorMessage = `âŒ ${error.message || 'æœªçŸ¥é”™è¯¯'}`;
          }
          showNotification(errorMessage, 'error');
        });
    };
    // ========== å•†æˆ·åŠŸèƒ½ ==========
    // ç”³è¯·æˆä¸ºå•†æˆ·ï¼ˆä¿®å¤ç‰ˆï¼šå…è®¸è¢«æ‹’åé‡æ–°ç”³è¯·ï¼‰
    function applyAsSeller() {
      if (!auth.currentUser) return;
      const user = auth.currentUser;
      
      db.ref("users/" + user.uid).once("value")
        .then(userSnapshot => {
          if (!userSnapshot.exists()) {
            showNotification('ç”¨æˆ·ä¿¡æ¯å¼‚å¸¸', 'error');
            return;
          }
          const userData = userSnapshot.val();
          if (userData.role === 'seller') {
            showNotification('æ‚¨å·²ç»æ˜¯å•†æˆ·äº†', 'warning');
            return;
          }
          
          // âœ… å…³é”®ä¿®å¤ï¼šä¸å†æ£€æŸ¥æ˜¯å¦å·²æœ‰ç”³è¯·ï¼
          // å…è®¸ç”¨æˆ·éšæ—¶æäº¤æ–°ç”³è¯·ï¼ˆå³ä½¿ä¹‹å‰è¢«æ‹’ï¼‰
          
          // ç›´æ¥åˆ›å»ºæ–°ç”³è¯·
          db.ref("sellerApplications").push({
            userId: user.uid,
            email: user.email,
            name: userData.name || 'æœªçŸ¥',
            status: 'pending',
            timestamp: firebase.database.ServerValue.TIMESTAMP
          })
          .then(() => {
            showNotification('å•†æˆ·ç”³è¯·å·²æäº¤ï¼Œç­‰å¾…ç®¡ç†å‘˜å®¡æ ¸');
          })
          .catch(error => {
            console.error('Create application error:', error);
            showNotification('ç”³è¯·æäº¤å¤±è´¥ï¼š' + (error.message || 'è¯·ç¨åé‡è¯•'), 'error');
          });
        })
        .catch(error => {
          console.error('User data error:', error);
          showNotification('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥ï¼š' + (error.message || 'è¯·ç¨åé‡è¯•'), 'error');
        });
    }
    function getTodayKey() {
      const now = new Date();
      return now.getFullYear() + 
        String(now.getMonth() + 1).padStart(2, '0') + 
        String(now.getDate()).padStart(2, '0');
    }
    // æ ¼å¼åŒ–ç§’æ•°ä¸º "1åˆ†30ç§’"
    function formatCooldown(seconds) {
      const mins = Math.floor(seconds / 60);
      const secs = seconds % 60;
      if (mins > 0) {
        return `${mins}åˆ†${secs}ç§’`;
      }
      return `${secs}ç§’`;
    }
    let cooldownTimer = null; // å…¨å±€å€’è®¡æ—¶å®šæ—¶å™¨

    // ========== ç”¨å›¾åºŠä¸Šä¼ å•†å“å›¾ç‰‡ + è¿›åº¦æ¡ + é¢„è§ˆ + é™ä¼  + å†·å´ ==========
    async function uploadProduct() {
      if (!auth.currentUser) return;
      const user = auth.currentUser;
      const uid = user.uid;
      const name = document.getElementById('productName').value.trim();
      const desc = document.getElementById('productDesc').value.trim();
      const price = parseInt(document.getElementById('productPrice').value);
      const imageFile = document.getElementById('productImage').files[0];

      if (!name || !desc || !price || price <= 0) {
        showNotification('è¯·å¡«å†™å®Œæ•´å•†å“ä¿¡æ¯', 'warning');
        return;
      }

      // === æ£€æŸ¥å†·å´æ—¶é—´ï¼ˆ90ç§’ï¼‰ ===
      const lastUploadRef = db.ref(`lastProductUpload/${uid}`);
      try {
        const snapshot = await lastUploadRef.once('value');
        if (snapshot.exists()) {
          const lastUploadTime = snapshot.val();
          const now = Date.now();
          const cooldownMs = 90 * 1000;
          const remainingMs = lastUploadTime + cooldownMs - now;
          if (remainingMs > 0) {
            const remainingSecs = Math.ceil(remainingMs / 1000);
            const mins = Math.floor(remainingSecs / 60);
            const secs = remainingSecs % 60;
            const timeStr = mins > 0 ? `${mins}åˆ†${secs}ç§’` : `${secs}ç§’`;
            showNotification(`â³ è¯·ç­‰å¾… ${timeStr} åå†ä¸Šæ¶å•†å“`, 'warning');
            return;
          }
        }
      } catch (e) {
        console.warn('æ£€æŸ¥å†·å´æ—¶é—´å¤±è´¥:', e);
      }

      // === æ£€æŸ¥ä»Šæ—¥æ˜¯å¦å·²ä¸Šä¼ è¿‡å›¾ç‰‡ ===
      if (imageFile) {
        const todayKey = getTodayKey();
        const uploadRef = db.ref(`dailyUploads/${uid}/${todayKey}`);
        try {
          const snapshot = await uploadRef.once('value');
          if (snapshot.exists()) {
            showNotification('âš ï¸ æ‚¨ä»Šå¤©å·²ä¸Šä¼ è¿‡å•†å“å›¾ç‰‡ï¼Œæ¯å¤©é™ä¼  1 å¼ ', 'error');
            return;
          }
        } catch (e) {
          console.warn('æ£€æŸ¥ä¸Šä¼ è®°å½•å¤±è´¥:', e);
        }
      }

      // === åˆ›å»ºé¢„è§ˆå’Œè¿›åº¦æ¡å®¹å™¨ ===
      const previewContainer = document.createElement('div');
      previewContainer.className = 'image-preview';
      previewContainer.style.cssText = 'margin: 15px 0; text-align: center; display: none;';
      const previewImg = document.createElement('img');
      previewImg.style.cssText = 'max-width: 100%; max-height: 200px; border-radius: 8px; display: none;';
      previewContainer.appendChild(previewImg);

      const progressBarContainer = document.createElement('div');
      progressBarContainer.className = 'upload-progress';
      progressBarContainer.style.cssText = 'margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 10px; display: none;';
      const progressLabel = document.createElement('div');
      progressLabel.textContent = 'ä¸Šä¼ è¿›åº¦:';
      progressLabel.style.marginBottom = '10px';
      const progressBar = document.createElement('div');
      progressBar.style.cssText = 'width: 100%; height: 8px; background: #dfe6e9; border-radius: 4px; overflow: hidden;';
      const progressInner = document.createElement('div');
      progressInner.style.cssText = 'height: 100%; background: var(--primary); width: 0%; transition: width 0.3s ease;';
      progressBar.appendChild(progressInner);
      const progressText = document.createElement('div');
      progressText.style.fontSize = '14px';
      progressText.style.color = 'var(--dark)';
      progressText.textContent = '0%';
      progressBarContainer.appendChild(progressLabel);
      progressBarContainer.appendChild(progressBar);
      progressBarContainer.appendChild(progressText);

      const form = document.querySelector('.upload-form');
      form.insertBefore(progressBarContainer, document.getElementById('submitProductBtn'));
      form.insertBefore(previewContainer, document.getElementById('submitProductBtn'));

      let imgUrl = '';

      // === å¤„ç†å›¾ç‰‡æ–‡ä»¶ï¼ˆé¢„è§ˆ + ä¸Šä¼ ï¼‰ ===
      if (imageFile) {
        // æ–‡ä»¶æ ¡éªŒ
        if (!imageFile.type.startsWith('image/')) {
          showNotification('è¯·ä¸Šä¼  JPG/PNG ç­‰å›¾ç‰‡æ ¼å¼', 'error');
          return;
        }
        if (imageFile.size > 32 * 1024 * 1024) {
          showNotification('å›¾ç‰‡ä¸èƒ½è¶…è¿‡ 32MB', 'error');
          return;
        }

        // æ˜¾ç¤ºé¢„è§ˆ
        const reader = new FileReader();
        reader.onload = (e) => {
          previewImg.src = e.target.result;
          previewImg.style.display = 'block';
          previewContainer.style.display = 'block';
        };
        reader.readAsDataURL(imageFile);

        // æ˜¾ç¤ºè¿›åº¦æ¡
        progressBarContainer.style.display = 'block';
        showNotification('æ­£åœ¨ä¸Šä¼ å›¾ç‰‡...');

        const formData = new FormData();
        formData.append('image', imageFile);

        try {
          const xhr = new XMLHttpRequest();
          xhr.open('POST', 'https://api.imgbb.com/1/upload?key=221529865c2562c3e906562c52e1177d', true);
          
          // ç›‘å¬ä¸Šä¼ è¿›åº¦
          xhr.upload.onprogress = (event) => {
            if (event.lengthComputable) {
              const percentComplete = Math.round((event.loaded / event.total) * 100);
              progressInner.style.width = `${percentComplete}%`;
              progressText.textContent = `${percentComplete}%`;
            }
          };

          // å‘é€è¯·æ±‚
          xhr.send(formData);

          // ç­‰å¾…å®Œæˆ
          await new Promise((resolve, reject) => {
            xhr.onload = () => {
              if (xhr.status === 200) {
                resolve(xhr.responseText);
              } else {
                reject(new Error(`HTTP ${xhr.status}`));
              }
            };
            xhr.onerror = () => reject(new Error('ç½‘ç»œé”™è¯¯'));
            xhr.timeout = 30000; // 30ç§’è¶…æ—¶
            xhr.ontimeout = () => reject(new Error('ä¸Šä¼ è¶…æ—¶'));
          });

          const result = JSON.parse(xhr.responseText);
          console.log('ImgBB è¿”å›ç»“æœ:', result);

          // âœ… ä¸¥æ ¼æ ¡éªŒ URL
          if (result.success && result.data && typeof result.data.url === 'string' && result.data.url.trim() !== '') {
            imgUrl = result.data.url.trim();
            console.log('âœ… è·å–åˆ°å›¾ç‰‡ URL:', imgUrl);
            progressInner.style.width = '100%';
            progressText.textContent = '100% - ä¸Šä¼ æˆåŠŸï¼';
            showNotification('âœ… å›¾ç‰‡ä¸Šä¼ æˆåŠŸï¼', 'success');
          } else {
            throw new Error(`å›¾åºŠè¿”å›æ— æ•ˆæ•°æ®: ${JSON.stringify(result)}`);
          }
        } catch (error) {
          console.error('ImgBB ä¸Šä¼ å¤±è´¥:', error);
          showNotification('å›¾ç‰‡ä¸Šä¼ å¤±è´¥: ' + (error.message || 'è¯·é‡è¯•'), 'error');
          // æ¸…ç† UI
          progressBarContainer.remove();
          previewContainer.remove();
          return;
        }
      }

      // === ä¿å­˜å•†å“åˆ°æ•°æ®åº“ ===
      showNotification('æ­£åœ¨ä¸Šæ¶å•†å“...');
      try {
        const userData = (await db.ref("users/" + uid).once("value")).val();
        const sellerName = userData?.name || user.email.split('@')[0] || 'æœªçŸ¥å•†å®¶';

        // å†™å…¥å•†å“
        const newProductRef = await db.ref("products").push({
          name: name,
          desc: desc,
          price: price,
          img: imgUrl, // å¯èƒ½æ˜¯ç©ºå­—ç¬¦ä¸²ï¼ˆæ— å›¾å•†å“ï¼‰æˆ–æœ‰æ•ˆ URL
          sellerId: uid,
          sellerName: sellerName,
          timestamp: firebase.database.ServerValue.TIMESTAMP,
          sales: 0
        });

        // === è®°å½•å†·å´æ—¶é—´ ===
        await db.ref(`lastProductUpload/${uid}`).set(Date.now());

        // === è®°å½•ä»Šæ—¥ä¸Šä¼ ï¼ˆä»…å½“æœ‰å›¾ï¼‰===
        if (imageFile && imgUrl) {
          const todayKey = getTodayKey();
          await db.ref(`dailyUploads/${uid}/${todayKey}`).set(true);
        }

        // æ¸…ç©ºè¡¨å•
        document.getElementById('productName').value = '';
        document.getElementById('productDesc').value = '';
        document.getElementById('productPrice').value = '';
        document.getElementById('productImage').value = '';
        
        // ç§»é™¤é¢„è§ˆå’Œè¿›åº¦æ¡
        progressBarContainer.remove();
        previewContainer.remove();

        showNotification('âœ… å•†å“ä¸Šæ¶æˆåŠŸï¼90ç§’åå¯å†æ¬¡ä¸Šæ¶', 'success');
        renderProducts();

      } catch (error) {
        console.error('ä¸Šæ¶å¤±è´¥:', error);
        showNotification('ä¸Šæ¶å¤±è´¥: ' + (error.message || 'è¯·é‡è¯•'), 'error');
        // æ¸…ç† UI
        progressBarContainer.remove();
        previewContainer.remove();
      }
    }
    // ========== ç®¡ç†å‘˜åŠŸèƒ½ ==========
    function showAdminPanel() {
      if (!auth.currentUser) {
        showNotification('è¯·å…ˆç™»å½•', 'warning');
        return;
      }
      db.ref("users/" + auth.currentUser.uid).once("value")
        .then(userSnapshot => {
          if (!userSnapshot.exists()) {
            showNotification('ç”¨æˆ·ä¿¡æ¯ä¸å­˜åœ¨', 'error');
            return;
          }
          const userData = userSnapshot.val();
          if (userData.role !== 'admin') {
            showNotification('ä½ æ²¡æœ‰ç®¡ç†å‘˜æƒé™', 'error');
            return;
          }
          adminModal.classList.add('active');
          loadApplications();
          loadUsers();
        })
        .catch(error => {
          console.error('Admin check error:', error);
          showNotification('æƒé™æ£€æŸ¥å¤±è´¥', 'error');
        });
    }
    // åŠ è½½å•†æˆ·ç”³è¯·
    function loadApplications() {
      applicationsList.innerHTML = '<div class="gray">åŠ è½½ä¸­...</div>';
      db.ref("sellerApplications").orderByChild("status").equalTo("pending")
        .once("value")
        .then(snapshot => {
          if (!snapshot.exists()) {
            applicationsList.innerHTML = '<div class="gray">æš‚æ— ç”³è¯·</div>';
            return;
          }
          let html = "";
          snapshot.forEach(child => {
            const app = child.val();
            html += `
              <div class="application-item">
                <div>
                  <div><b>${app.name}</b></div>
                  <div>${app.email}</div>
                </div>
                <div>
                  <button class="success approve-btn" onclick="approveApplication('${child.key}')">åŒæ„</button>
                  <button class="danger reject-btn" onclick="rejectApplication('${child.key}')">æ‹’ç»</button>
                </div>
              </div>
            `;
          });
          applicationsList.innerHTML = html;
        })
        .catch(error => {
          console.error('Load applications error:', error);
          if (error.code !== 'PERMISSION_DENIED') {
            applicationsList.innerHTML = '<div class="gray">åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•</div>';
          } else {
            applicationsList.innerHTML = '<div class="gray">æ— æƒé™è®¿é—®ç”³è¯·æ•°æ®</div>';
          }
        });
    }
    // æ‰¹å‡†ç”³è¯·
    function approveApplication(appId) {
      db.ref("sellerApplications/" + appId).once("value")
        .then(snapshot => {
          if (!snapshot.exists()) return;
          const app = snapshot.val();
          // æ›´æ–°ç”¨æˆ·è§’è‰²
          db.ref("users/" + app.userId + "/role").set("seller")
            .then(() => {
              // æ›´æ–°ç”³è¯·çŠ¶æ€
              db.ref("sellerApplications/" + appId + "/status").set("approved");
              showNotification(`å·²æ‰¹å‡† ${app.name} çš„ç”³è¯·`);
              // ç»™ç”¨æˆ·å‘é€é€šçŸ¥
              db.ref("notifications/" + app.userId).push({
                message: "ä½ çš„å•†æˆ·ç”³è¯·å·²è¢«åŒæ„",
                type: "success",
                timestamp: firebase.database.ServerValue.TIMESTAMP
              });
              loadApplications();
            })
            .catch(error => {
              console.error('Approve application error:', error);
              showNotification('æ‰¹å‡†å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
            });
        })
        .catch(error => {
          console.error('Load application error:', error);
          showNotification('è·å–ç”³è¯·ä¿¡æ¯å¤±è´¥', 'error');
        });
    }
    // æ‹’ç»ç”³è¯·
    function rejectApplication(appId) {
      db.ref("sellerApplications/" + appId).once("value")
        .then(snapshot => {
          if (!snapshot.exists()) return;
          const app = snapshot.val();
          // æ›´æ–°ç”³è¯·çŠ¶æ€
          db.ref("sellerApplications/" + appId + "/status").set("rejected")
            .then(() => {
              showNotification(`å·²æ‹’ç» ${app.name} çš„ç”³è¯·`);
              // ç»™ç”¨æˆ·å‘é€é€šçŸ¥
              db.ref("notifications/" + app.userId).push({
                message: "ä½ çš„å•†æˆ·ç”³è¯·å·²è¢«æ‹’ç»",
                type: "error",
                timestamp: firebase.database.ServerValue.TIMESTAMP
              });
              loadApplications();
            })
            .catch(error => {
              console.error('Reject application error:', error);
              showNotification('æ‹’ç»å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
            });
        })
        .catch(error => {
          console.error('Load application error:', error);
          showNotification('è·å–ç”³è¯·ä¿¡æ¯å¤±è´¥', 'error');
        });
    }
    // åŠ è½½æ‰€æœ‰ç”¨æˆ·
    function loadUsers() {
      usersList.innerHTML = '<div class="gray">åŠ è½½ä¸­...</div>';
      db.ref("users").once("value")
        .then(snapshot => {
          if (!snapshot.exists()) {
            usersList.innerHTML = '<div class="gray">æš‚æ— ç”¨æˆ·</div>';
            return;
          }
          let html = "";
          snapshot.forEach(child => {
            const user = child.val();
            html += `
              <div class="user-item">
                <div class="user-info">
                  <span><b>${user.name}</b></span>
                  <span>${user.email}</span>
                  <span>åå¸: <input type="number" class="points-input" value="${user.points || 0}" data-uid="${child.key}"> 
                    <button class="primary" onclick="updateUserPoints('${child.key}')">æ›´æ–°</button>
                  </span>
                </div>
                <div>
                  ${user.banned ? 
                    '<button class="success unban-btn" onclick="unbanUser(\'' + child.key + '\')">è§£å°</button>' : 
                    '<button class="danger ban-btn" onclick="banUser(\'' + child.key + '\')">å°ç¦</button>'
                  }
                </div>
              </div>
            `;
          });
          usersList.innerHTML = html;
        })
        .catch(error => {
          console.error('Load users error:', error);
          if (error.code !== 'PERMISSION_DENIED') {
            usersList.innerHTML = '<div class="gray">åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•</div>';
          } else {
            usersList.innerHTML = '<div class="gray">æ— æƒé™è®¿é—®ç”¨æˆ·æ•°æ®</div>';
          }
        });
    }
    // æ›´æ–°ç”¨æˆ·åå¸
    function updateUserPoints(uid) {
      const input = document.querySelector(`.points-input[data-uid="${uid}"]`);
      const newPoints = parseInt(input.value);
      if (isNaN(newPoints) || newPoints < 0) {
        showNotification("è¯·è¾“å…¥æœ‰æ•ˆçš„åå¸æ•°é‡", 'error');
        return;
      }
      db.ref("users/" + uid + "/points").set(newPoints)
        .then(() => {
          showNotification("åå¸æ›´æ–°æˆåŠŸ");
          // ç»™ç”¨æˆ·å‘é€é€šçŸ¥
          db.ref("notifications/" + uid).push({
            message: `ç®¡ç†å‘˜ä¿®æ”¹äº†ä½ çš„åå¸ï¼Œå½“å‰åå¸: ${newPoints}`,
            type: "info",
            timestamp: firebase.database.ServerValue.TIMESTAMP
          });
        })
        .catch(error => {
          console.error('Update points error:', error);
          showNotification('æ›´æ–°å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
        });
    }
    // å°ç¦ç”¨æˆ·
    function banUser(uid) {
      db.ref("users/" + uid + "/banned").set(true)
        .then(() => {
          showNotification("ç”¨æˆ·å·²å°ç¦");
          // ç»™ç”¨æˆ·å‘é€é€šçŸ¥
          db.ref("notifications/" + uid).push({
            message: "ä½ çš„è´¦å·å·²è¢«ç®¡ç†å‘˜å°ç¦",
            type: "error",
            timestamp: firebase.database.ServerValue.TIMESTAMP
          });
          loadUsers();
        })
        .catch(error => {
          console.error('Ban user error:', error);
          showNotification('å°ç¦å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
        });
    }
    // è§£å°ç”¨æˆ·
    function unbanUser(uid) {
      db.ref("users/" + uid + "/banned").set(false)
        .then(() => {
          showNotification("ç”¨æˆ·å·²è§£å°");
          loadUsers();
        })
        .catch(error => {
          console.error('Unban user error:', error);
          showNotification('è§£å°å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
        });
    }
    // ========== å•†å®¶è®¢å•åŠŸèƒ½ ==========
    function showSellerOrders() {
      if (!auth.currentUser) {
        showNotification('è¯·å…ˆç™»å½•', 'warning');
        return;
      }
      db.ref("users/" + auth.currentUser.uid).once("value")
        .then(userSnapshot => {
          if (!userSnapshot.exists()) {
            showNotification('ç”¨æˆ·ä¿¡æ¯ä¸å­˜åœ¨', 'error');
            return;
          }
          const userData = userSnapshot.val();
          if (userData.role !== 'seller' && userData.role !== 'admin') {
            showNotification('ä½ æ²¡æœ‰æŸ¥çœ‹è®¢å•çš„æƒé™', 'error');
            return;
          }
          // åŠ è½½å•†å®¶è®¢å•
          loadSellerOrders();
          sellerOrdersModal.classList.add('active');
        })
        .catch(error => {
          console.error('Seller check error:', error);
          showNotification('æƒé™æ£€æŸ¥å¤±è´¥', 'error');
        });
    }
    function loadSellerOrders() {
      sellerOrdersList.innerHTML = '<div class="gray">åŠ è½½ä¸­...</div>';
      if (!auth.currentUser) {
        sellerOrdersList.innerHTML = '<div class="gray">è¯·å…ˆç™»å½•</div>';
        return;
      }
      const sellerId = auth.currentUser.uid;
      // ä½¿ç”¨æ­£ç¡®çš„æŸ¥è¯¢æ–¹å¼
      db.ref("orders")
        .orderByChild("sellerId")
        .equalTo(sellerId)
        .once("value")
        .then(snapshot => {
          if (!snapshot.exists()) {
            sellerOrdersList.innerHTML = '<div class="gray">æš‚æ— è®¢å•è®°å½•</div>';
            return;
          }
          let orders = [];
          snapshot.forEach(child => {
            orders.push({ id: child.key, ...child.val() });
          });
          // æŒ‰æ—¶é—´å€’åºæ’åˆ—
          orders.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
          if (orders.length === 0) {
            sellerOrdersList.innerHTML = '<div class="gray">æš‚æ— è®¢å•è®°å½•</div>';
            return;
          }
          // æ„å»ºè®¢å•HTML
          let html = '';
          orders.forEach(order => {
            const buyerName = order.buyerName || 'æœªçŸ¥ç”¨æˆ·';
            const time = order.timestamp ? 
              new Date(order.timestamp).toLocaleString('zh-CN') : 'æœªçŸ¥æ—¶é—´';
            html += `
              <div class="order-item">
                <div class="order-header">
                  <span class="order-buyer">${buyerName}</span>
                  <span class="order-points">+${order.points || 0}åå¸</span>
                </div>
                <div class="order-product">å•†å“ï¼š${order.productName || 'æœªçŸ¥å•†å“'}</div>
                <div class="order-sales">é”€é‡ï¼š1 ä»¶</div>
                <div class="order-time">
                  <i class="fas fa-clock"></i> ${time}
                </div>
              </div>
            `;
          });
          sellerOrdersList.innerHTML = html;
        })
        .catch(error => {
          console.error('Load seller orders error:', error);
          let errorMessage = 'åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•';
          if (error.code === 'PERMISSION_DENIED') {
            errorMessage = 'æ— æƒé™è®¿é—®è®¢å•æ•°æ®';
            sellerOrdersList.innerHTML = '<div class="gray">æ— æƒé™è®¿é—®è®¢å•æ•°æ®</div>';
          }
          showNotification(`åŠ è½½è®¢å•å¤±è´¥: ${errorMessage}`, 'error');
        });
    }
    // ========== ç”¨æˆ·ç•Œé¢æ›´æ–° ==========
    function updateUserInterface() {
      const user = auth.currentUser;
      if (user) {
        // è·å–ç”¨æˆ·ä¿¡æ¯
        db.ref("users/" + user.uid).once("value")
          .then(userSnapshot => {
            if (!userSnapshot.exists()) {
              showNotification('ç”¨æˆ·æ•°æ®å¼‚å¸¸ï¼Œè¯·é‡æ–°ç™»å½•', 'error');
              auth.signOut();
              return;
            }
            const userData = userSnapshot.val();
            if (userData.banned) {
              showNotification('ä½ å·²è¢«å°ç¦', 'error');
              auth.signOut();
              return;
            }
            // æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
            authButtons.classList.add('hidden');
            userInfoNav.classList.remove('hidden');
            userPanelSection.style.display = 'block';
            // æ›´æ–°ç”¨æˆ·ä¿¡æ¯
            const displayName = userData.name || user.email?.split('@')[0] || 'ç”¨æˆ·';
            userName.textContent = displayName;
            userAvatar.textContent = getInitials(displayName);
            userRole.textContent = userData.role === 'admin' ? 'ç®¡ç†å‘˜' : 
                                 userData.role === 'seller' ? 'å•†æˆ·' : 'æ™®é€šç”¨æˆ·';
            userPoints.textContent = userData.points || 0;
            // æ ¹æ®è§’è‰²æ˜¾ç¤ºåŠŸèƒ½
            sellerFormSection.classList.add('hidden');
            if (userData.role === 'seller' || userData.role === 'admin') {
              sellerFormSection.classList.remove('hidden');
            }
            // æ˜¾ç¤ºç®¡ç†å‘˜å’Œå•†å®¶æŒ‰é’®
            adminBtn.classList.add('hidden');
            sellerOrdersBtn.classList.add('hidden');
            if (userData.role === 'admin') {
              adminBtn.classList.remove('hidden');
            }
            if (userData.role === 'seller' || userData.role === 'admin') {
              sellerOrdersBtn.classList.remove('hidden');
            }
            // å®æ—¶ç›‘å¬åå¸å˜åŒ–
            db.ref("users/" + user.uid + "/points").on("value", pointsSnapshot => {
              userPoints.textContent = pointsSnapshot.val() || 0;
            });
          })
          .catch(error => {
            console.error('User data error:', error);
            if (error.code !== 'PERMISSION_DENIED') {
              showNotification('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥', 'error');
            }
          });
      } else {
        // æœªç™»å½•çŠ¶æ€
        authButtons.classList.remove('hidden');
        userInfoNav.classList.add('hidden');
        userPanelSection.style.display = 'none';
        adminBtn.classList.add('hidden');
        sellerOrdersBtn.classList.add('hidden');
      }
      // æ¸²æŸ“å•†å“
      renderProducts();
    }
    // ä¸´æ—¶æƒé™éªŒè¯å‡½æ•° - éƒ¨ç½²æˆåŠŸåå¯åˆ é™¤
    function verifyPermissions() {
      if (!auth.currentUser) return;
      const testPath = `test_permissions_${Date.now()}`;
      const testValue = { timestamp: Date.now() };
      // æµ‹è¯•å†™å…¥æƒé™
      db.ref(`orders/${testPath}`).set(testValue)
        .then(() => {
          console.log('âœ… è®¢å•å†™å…¥æƒé™æ­£å¸¸');
          db.ref(`orders/${testPath}`).remove();
        })
        .catch(error => {
          console.error('âŒ è®¢å•å†™å…¥æƒé™å¤±è´¥:', error);
          showNotification('ç³»ç»Ÿæƒé™é…ç½®é”™è¯¯ï¼Œè¯·è”ç³»ç®¡ç†å‘˜', 'error');
        });
      // æµ‹è¯•è¯»å–æƒé™
      db.ref('products').limitToFirst(1).once('value')
        .then(snapshot => {
          if (snapshot.exists()) {
            console.log('âœ… å•†å“è¯»å–æƒé™æ­£å¸¸');
          } else {
            console.log('âš ï¸ æ²¡æœ‰å•†å“æ•°æ®ï¼Œä½†è¯»å–æƒé™æ­£å¸¸');
          }
        })
        .catch(error => {
          console.error('âŒ å•†å“è¯»å–æƒé™å¤±è´¥:', error);
          showNotification('æ— æ³•åŠ è½½å•†å“ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥', 'error');
        });
    }
    // ====== æƒé™è¯Šæ–­å·¥å…·ï¼ˆéƒ¨ç½²åå¯åˆ é™¤ï¼‰======
    function runPermissionDiagnostics() {
      if (!auth.currentUser) {
        console.log('âŒ æœªç™»å½•ï¼Œæ— æ³•è¿›è¡Œæƒé™è¯Šæ–­');
        return;
      }
      const userId = auth.currentUser.uid;
      const diagnosticKey = `diagnostic_${Date.now()}`;
      console.log('ğŸ” å¼€å§‹æƒé™è¯Šæ–­...');
      console.log('ğŸ‘¤ å½“å‰ç”¨æˆ·ID:', userId);
      // 1. æ£€æŸ¥ç”¨æˆ·æ•°æ®è¯»å–æƒé™
      db.ref(`users/${userId}`).once('value')
        .then(snapshot => {
          if (snapshot.exists()) {
            console.log('âœ… ç”¨æˆ·æ•°æ®è¯»å–æˆåŠŸ');
            const userData = snapshot.val();
            console.log('ğŸ“Š ç”¨æˆ·æ•°æ®:', {
              role: userData.role,
              points: userData.points,
              banned: userData.banned
            });
            // 2. æµ‹è¯•åå¸å†™å…¥
            return db.ref(`users/${userId}/points`).transaction(current => {
              return (current || 0) + 0; // ä¸å®é™…ä¿®æ”¹ï¼Œåªæ˜¯æµ‹è¯•äº‹åŠ¡
            });
          } else {
            console.error('âŒ ç”¨æˆ·æ•°æ®ä¸å­˜åœ¨');
            throw new Error('ç”¨æˆ·æ•°æ®ä¸å­˜åœ¨');
          }
        })
        .then(() => {
          console.log('âœ… åå¸å†™å…¥æƒé™æµ‹è¯•æˆåŠŸ');
          // 3. æµ‹è¯•å•†å“è¯»å–
          return db.ref('products').limitToFirst(1).once('value');
        })
        .then(snapshot => {
          if (snapshot.exists()) {
            console.log('âœ… å•†å“è¯»å–æƒé™æˆåŠŸ');
            console.log('ğŸ“¦ æ£€æµ‹åˆ°å•†å“æ•°é‡:', Object.keys(snapshot.val()).length);
          } else {
            console.log('âš ï¸ æ— å•†å“æ•°æ®ï¼Œä½†è¯»å–æƒé™æ­£å¸¸');
          }
          // 4. æµ‹è¯•è®¢å•å†™å…¥
          return db.ref(`orders/${diagnosticKey}`).set({
            test: true,
            timestamp: Date.now()
          });
        })
        .then(() => {
          console.log('âœ… è®¢å•å†™å…¥æƒé™æˆåŠŸ');
          // 5. æµ‹è¯•è®¢å•è¯»å–
          return db.ref(`orders/${diagnosticKey}`).once('value');
        })
        .then(snapshot => {
          if (snapshot.exists()) {
            console.log('âœ… è®¢å•è¯»å–æƒé™æˆåŠŸ');
            // 6. æ¸…ç†æµ‹è¯•æ•°æ®
            return db.ref(`orders/${diagnosticKey}`).remove();
          } else {
            console.error('âŒ è®¢å•è¯»å–å¤±è´¥');
            throw new Error('è®¢å•è¯»å–å¤±è´¥');
          }
        })
        .then(() => {
          console.log('âœ… æµ‹è¯•æ•°æ®æ¸…ç†æˆåŠŸ');
          console.log('ğŸ‰ æƒé™è¯Šæ–­å®Œæˆï¼æ‰€æœ‰æƒé™æ­£å¸¸');
          showNotification('æƒé™è¯Šæ–­å®Œæˆï¼Œæ‰€æœ‰æƒé™æ­£å¸¸', 'success');
        })
        .catch(error => {
          console.error('âŒ æƒé™è¯Šæ–­å¤±è´¥:', error);
          console.error('ğŸ”§ è¯¦ç»†é”™è¯¯ä¿¡æ¯:', {
            code: error.code,
            message: error.message,
            stack: error.stack
          });
          // æä¾›å…·ä½“çš„ä¿®å¤å»ºè®®
          let fixAdvice = 'è¯·è”ç³»ç®¡ç†å‘˜æ£€æŸ¥Firebaseå®‰å…¨è§„åˆ™';
          if (error.message.includes('PERMISSION_DENIED')) {
            fixAdvice = 'å®‰å…¨è§„åˆ™é…ç½®é”™è¯¯ï¼Œéœ€è¦é‡æ–°éƒ¨ç½²è§„åˆ™å¹¶ç­‰å¾…3åˆ†é’Ÿ';
          } else if (error.message.includes('not found')) {
            fixAdvice = 'æ•°æ®åº“è·¯å¾„ä¸å­˜åœ¨ï¼Œè¯·æ£€æŸ¥æ•°æ®ç»“æ„';
          }
          console.log('ğŸ’¡ ä¿®å¤å»ºè®®:', fixAdvice);
          showNotification(`æƒé™è¯Šæ–­å¤±è´¥: ${error.message}`, 'error');
        });
    }
    // æ·»åŠ è¯Šæ–­æŒ‰é’®åˆ°é¡µé¢
    setTimeout(() => {
      const navbar = document.querySelector('.navbar');
      if (navbar) {
        const diagnosticBtn = document.createElement('button');
        diagnosticBtn.innerHTML = '<i class="fas fa-bug"></i> è¯Šæ–­æƒé™';
        diagnosticBtn.style.cssText = `
          background: #ff6b6b;
          color: white;
          border: none;
          padding: 8px 16px;
          border-radius: 8px;
          margin-left: 10px;
          cursor: pointer;
          font-weight: 500;
        `;
        diagnosticBtn.onclick = runPermissionDiagnostics;
        navbar.appendChild(diagnosticBtn);
      }
    }, 1000);
    // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¿è¡Œè¯Šæ–­ï¼ˆä»…ç”¨äºè°ƒè¯•ï¼‰
    window.addEventListener('load', () => {
      setTimeout(() => {
        if (auth.currentUser && window.location.search.includes('diagnose')) {
          runPermissionDiagnostics();
        }
      }, 2000);
    });
    // ====== æƒé™è¯Šæ–­å·¥å…·ç»“æŸ ======
    // åœ¨åˆå§‹åŒ–æ—¶è°ƒç”¨
    auth.onAuthStateChanged(user => {
      if (user) {
        setTimeout(verifyPermissions, 3000); // ç­‰å¾…è§„åˆ™å®Œå…¨ç”Ÿæ•ˆ
      }
      updateUserInterface();
    });
    // ========== äº‹ä»¶ç›‘å¬å™¨ ==========
    loginBtn.addEventListener('click', showLoginModal);
    logoutBtn.addEventListener('click', () => {
      auth.signOut()
        .then(() => showNotification('å·²é€€å‡ºç™»å½•'));
    });
    adminBtn.addEventListener('click', showAdminPanel);
    sellerOrdersBtn.addEventListener('click', showSellerOrders);
    switchToRegister.addEventListener('click', () => switchTab('register'));
    switchToLogin.addEventListener('click', () => switchTab('login'));
    tabs.forEach(tab => {
      tab.addEventListener('click', () => switchTab(tab.dataset.tab));
    });
    loginForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const email = document.getElementById('loginEmail').value;
      const password = document.getElementById('loginPassword').value;
      handleLogin(email, password);
    });
    registerForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const email = document.getElementById('registerEmail').value;
      const password = document.getElementById('registerPassword').value;
      const name = document.getElementById('registerName').value;
      handleRegister(email, password, name);
    });
    applySellerBtn.addEventListener('click', applyAsSeller);
    submitProductBtn.addEventListener('click', uploadProduct);
    // ç®¡ç†å‘˜æ ‡ç­¾åˆ‡æ¢
    document.querySelectorAll('.admin-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.admin-pane').forEach(p => p.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById(`${tab.dataset.tab}Pane`).classList.add('active');
      });
    });
    // ========== åˆå§‹åŒ– ==========
    auth.onAuthStateChanged(user => {
      if (user) {
        hideLoginModal();
      }
      updateUserInterface();
    });
    // åˆå§‹æ¸²æŸ“å•†å“
    renderProducts();
    // åˆå§‹åŒ–è¡¨å•åˆ‡æ¢
    switchTab('login');
    // åœ¨ä½ åŸæœ‰ <script> çš„æœ€åº•éƒ¨ï¼ˆæ‰€æœ‰å‡½æ•°ä¹‹åï¼‰ï¼Œæ·»åŠ ä»¥ä¸‹å‡½æ•°
    // ========== ç®¡ç†å‘˜åˆ é™¤å•†å“åŠŸèƒ½ ==========
    window.deleteProduct = function(productId, imageUrl) {
      // è·å–å½“å‰ç”¨æˆ·è§’è‰²
      const user = auth.currentUser;
      if (!user) {
        showNotification('è¯·å…ˆç™»å½•', 'error');
        return;
      }
      db.ref(`users/${user.uid}`).once('value')
        .then(userSnap => {
          if (!userSnap.exists() || userSnap.val().role !== 'admin') {
            showNotification('æ— æƒé™åˆ é™¤å•†å“', 'error');
            return;
          }
          if (!confirm('ç¡®å®šåˆ é™¤æ­¤å•†å“ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
            return;
          }
          showNotification('æ­£åœ¨åˆ é™¤å•†å“...');
          // åˆ é™¤å›¾ç‰‡ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          let deleteImagePromise = Promise.resolve();
          if (imageUrl && imageUrl.startsWith('https://firebasestorage.googleapis.com/')) {
            const imageRef = storage.refFromURL(imageUrl);
            deleteImagePromise = imageRef.delete().catch(e => {
              console.warn('å›¾ç‰‡åˆ é™¤å¤±è´¥ï¼ˆå¯èƒ½å·²ä¸å­˜åœ¨ï¼‰:', e);
            });
          }
          // åˆ é™¤å•†å“æ•°æ®
          deleteImagePromise
            .then(() => db.ref(`products/${productId}`).remove())
            .then(() => {
              showNotification('å•†å“å·²æˆåŠŸåˆ é™¤', 'success');
              renderProducts(); // åˆ·æ–°å•†å“åˆ—è¡¨
            })
            .catch(error => {
              console.error('åˆ é™¤å•†å“å¤±è´¥:', error);
              showNotification('åˆ é™¤å¤±è´¥ï¼š' + (error.message || 'è¯·ç¨åé‡è¯•'), 'error');
            });
        })
        .catch(err => {
          console.error('æƒé™æ£€æŸ¥å¤±è´¥:', err);
          showNotification('æƒé™éªŒè¯å¤±è´¥', 'error');
        });
    };
  </script>
</body>
</html>
